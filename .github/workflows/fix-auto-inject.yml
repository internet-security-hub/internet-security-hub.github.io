name: Fix Auto-Inject Dates
on:
  workflow_dispatch:

jobs:
  auto-inject:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - name: Debug - List files
        run: |
          echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–æ—Ä–Ω–µ–≤–æ–π –ø–∞–ø–∫–∏:"
          ls -la
          echo "–ü–æ–∏—Å–∫ .sh —Ñ–∞–π–ª–æ–≤:"
          find . -name "*.sh" -type f
        
      - name: Create and run auto-inject script
        run: |
          # –°–æ–∑–¥–∞–µ–º —Å–∫—Ä–∏–ø—Ç –ø—Ä—è–º–æ –∑–¥–µ—Å—å
          cat > auto-inject-fix.sh << 'EOF'
          #!/bin/bash
          echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –≤—Å—Ç–∞–≤–∫—É —Å–∫—Ä–∏–ø—Ç–æ–≤..."
          
          # –ú–æ—Å–∫–æ–≤—Å–∫–∞—è –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è
          MOSCOW_DATE=$(TZ=Europe/Moscow date +"%Y-%m-%d")
          MOSCOW_DATETIME="${MOSCOW_DATE}T01:00:00+03:00"
          
          echo "–ú–æ—Å–∫–æ–≤—Å–∫–∞—è –¥–∞—Ç–∞: $MOSCOW_DATE"
          
          # –°—á–µ—Ç—á–∏–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
          COUNT=0
          
          # –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤—Å–µ HTML —Ñ–∞–π–ª—ã
          find . -name "*.html" -type f | while read file; do
              echo "–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º: $file"
              
              # –î–æ–±–∞–≤–∏—Ç—å meta-—Ç–µ–≥ modified_time –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
              if ! grep -q 'article:modified_time' "$file"; then
                  sed -i '/<meta name="viewport"/a <meta property="article:modified_time" content="'"$MOSCOW_DATETIME"'">' "$file"
                  echo "‚úÖ –î–æ–±–∞–≤–ª–µ–Ω meta-—Ç–µ–≥ –≤ $file"
              else
                  # –û–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π
                  sed -i 's/<meta property="article:modified_time" content="[^"]*"/<meta property="article:modified_time" content="'"$MOSCOW_DATETIME"'"/g' "$file"
                  echo "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω meta-—Ç–µ–≥ –≤ $file"
              fi
              
              # –î–æ–±–∞–≤–∏—Ç—å JavaScript —Å–∫—Ä–∏–ø—Ç –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
              if ! grep -q "moscowTime.*toLocaleString" "$file"; then
                  cat >> "$file" << 'SCRIPT_EOF'
          
          <script>
          // –ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞—Ç - Moscow Time
          (function() {
              const moscowTime = new Date().toLocaleString("en-US", {timeZone: "Europe/Moscow"});
              const moscowDate = new Date(moscowTime).toISOString().split('T')[0];
              const moscowDateTime = moscowDate + 'T01:00:00+03:00';
              
              let metaModified = document.querySelector('meta[property="article:modified_time"]');
              if (!metaModified) {
                  metaModified = document.createElement('meta');
                  metaModified.setAttribute('property', 'article:modified_time');
                  document.head.appendChild(metaModified);
              }
              metaModified.setAttribute('content', moscowDateTime);
              
              document.querySelectorAll('script[type="application/ld+json"]').forEach(script => {
                  try {
                      const data = JSON.parse(script.textContent);
                      if (data.dateModified) data.dateModified = moscowDate;
                      script.textContent = JSON.stringify(data, null, 2);
                  } catch(e) {}
              });
          })();
          </script>
          SCRIPT_EOF
                  echo "üìú –î–æ–±–∞–≤–ª–µ–Ω JavaScript –≤ $file"
              fi
              
              COUNT=$((COUNT + 1))
          done
          
          echo "üéâ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Ñ–∞–π–ª–æ–≤: $COUNT"
          EOF
          
          # –°–¥–µ–ª–∞—Ç—å –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å
          chmod +x auto-inject-fix.sh
          ./auto-inject-fix.sh
          
      - name: Update sitemap
        run: |
          MOSCOW_DATE=$(TZ=Europe/Moscow date +"%Y-%m-%d")
          if [ -f "sitemap.xml" ]; then
              sed -i 's/<lastmod>[^<]*<\/lastmod>/<lastmod>'"$MOSCOW_DATE"'<\/lastmod>/g' sitemap.xml
              echo "‚úÖ Sitemap –æ–±–Ω–æ–≤–ª–µ–Ω"
          fi
          
      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "Auto-Inject Bot"
          git add -A
          
          if ! git diff --staged --quiet; then
            MOSCOW_TIME=$(TZ=Europe/Moscow date +"%Y-%m-%d %H:%M MSK")
            git commit -m "ü§ñ –£—Å–ø–µ—à–Ω–∞—è –≤—Å—Ç–∞–≤–∫–∞ —Å–∫—Ä–∏–ø—Ç–æ–≤ –¥–∞—Ç: $MOSCOW_TIME"
            git push
            echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–∫–æ–º–º–∏—á–µ–Ω—ã –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã!"
          else
            echo "‚ÑπÔ∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
          fi
