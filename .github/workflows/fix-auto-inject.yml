name: Simple Auto-Inject (Fixed)
on:
  workflow_dispatch:

jobs:
  inject:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Debug current state
        run: |
          echo "=== –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ==="
          git status
          echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ HTML —Ñ–∞–π–ª–æ–≤ ==="
          find . -name "*.html" -exec grep -l "article:modified_time" {} \; | head -5
          
      - name: Force inject auto-dates
        run: |
          MOSCOW_DATE=$(TZ=Europe/Moscow date +"%Y-%m-%d")
          MOSCOW_DATETIME="${MOSCOW_DATE}T01:00:00+03:00"
          
          echo "–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞ –¥–∞—Ç—É: $MOSCOW_DATE"
          
          # –ù–∞–π—Ç–∏ –∏ –æ–±–Ω–æ–≤–∏—Ç—å –í–°–ï HTML —Ñ–∞–π–ª—ã
          find . -name "*.html" -type f | while read file; do
              echo "–û–±–Ω–æ–≤–ª—è–µ–º: $file"
              
              # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –í–°–ï –¥–∞—Ç—ã –Ω–∞ –Ω–æ–≤—ã–µ
              sed -i 's|content="2025-08-[0-9][0-9]T[0-9][0-9]:[0-9][0-9]:[0-9][0-9]+03:00"|content="'"$MOSCOW_DATETIME"'"|g' "$file"
              sed -i 's|"dateModified": "2025-08-[0-9][0-9]"|"dateModified": "'"$MOSCOW_DATE"'"|g' "$file"
              sed -i 's|<lastmod>2025-08-[0-9][0-9]</lastmod>|<lastmod>'"$MOSCOW_DATE"'</lastmod>|g' "$file"
              
              # –î–æ–±–∞–≤–∏—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å –≤—Ä–µ–º–µ–Ω–Ω–æ–π –º–µ—Ç–∫–æ–π –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
              TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
              if ! grep -q "auto-inject-timestamp" "$file"; then
                  sed -i 's|</body>|<!-- auto-inject-timestamp: '"$TIMESTAMP"' -->\n</body>|' "$file"
              else
                  sed -i 's|<!-- auto-inject-timestamp: [^>]* -->|<!-- auto-inject-timestamp: '"$TIMESTAMP"' -->|' "$file"
              fi
          done
          
      - name: Add JavaScript to all pages
        run: |
          # –î–æ–±–∞–≤–∏—Ç—å JavaScript —Å–∫—Ä–∏–ø—Ç –≤–æ –≤—Å–µ HTML —Ñ–∞–π–ª—ã
          find . -name "*.html" -type f | while read file; do
              if ! grep -q "Moscow Auto-Update Script" "$file"; then
                  cat >> temp_script.txt << 'EOF'

<script>
// Moscow Auto-Update Script - Injected $(date)
(function() {
    const moscowTime = new Date().toLocaleString("en-US", {timeZone: "Europe/Moscow"});
    const moscowDate = new Date(moscowTime).toISOString().split('T')[0];
    const moscowDateTime = moscowDate + 'T01:00:00+03:00';
    
    // Update meta tag
    let metaModified = document.querySelector('meta[property="article:modified_time"]');
    if (!metaModified) {
        metaModified = document.createElement('meta');
        metaModified.setAttribute('property', 'article:modified_time');
        document.head.appendChild(metaModified);
    }
    metaModified.setAttribute('content', moscowDateTime);
    
    // Update JSON-LD
    document.querySelectorAll('script[type="application/ld+json"]').forEach(script => {
        try {
            const data = JSON.parse(script.textContent);
            if (data.dateModified) data.dateModified = moscowDate;
            script.textContent = JSON.stringify(data, null, 2);
        } catch(e) {}
    });
    
    console.log('–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞:', moscowDateTime);
})();
</script>
EOF
                  
                  # –í—Å—Ç–∞–≤–∏—Ç—å —Å–∫—Ä–∏–ø—Ç –ø–µ—Ä–µ–¥ </body>
                  sed -i 's|</body>|'"$(cat temp_script.txt | tr '\n' '¬ß')"'</body>|' "$file"
                  sed -i 's/¬ß/\n/g' "$file"
                  echo "JavaScript –¥–æ–±–∞–≤–ª–µ–Ω –≤: $file"
              fi
          done
          
          # –£–¥–∞–ª–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
          rm -f temp_script.txt
          
      - name: Show changes
        run: |
          echo "=== –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã ==="
          git status --porcelain
          echo "=== –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ ==="
          git status --porcelain | wc -l
          
      - name: Commit with error handling
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # –î–æ–±–∞–≤–∏—Ç—å –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
          git add -A
          
          # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—Å—Ç—å –ª–∏ —á—Ç–æ –∫–æ–º–º–∏—Ç–∏—Ç—å
          if git diff --staged --quiet; then
              echo "‚ùå –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
              echo "–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–æ–∑–¥–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ..."
              echo "<!-- Force update: $(date) -->" >> README.md
              git add README.md
          fi
          
          # –ö–æ–º–º–∏—Ç —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
          MOSCOW_TIME=$(TZ=Europe/Moscow date +"%Y-%m-%d %H:%M MSK")
          if git commit -m "ü§ñ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞—Ç: $MOSCOW_TIME"; then
              echo "‚úÖ –ö–æ–º–º–∏—Ç —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ"
              
              # Push —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏
              for i in {1..3}; do
                  if git push; then
                      echo "‚úÖ Push –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ"
                      break
                  else
                      echo "‚ö†Ô∏è Push failed, –ø–æ–ø—ã—Ç–∫–∞ $i –∏–∑ 3"
                      sleep 2
                  fi
              done
          else
              echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ–º–º–∏—Ç–∞"
              git status
              exit 1
          fi
